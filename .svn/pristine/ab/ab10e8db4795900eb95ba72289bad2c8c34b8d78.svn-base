package spec.benchmarks.xml.validation;//####[1]####
//####[1]####
import pj.parser.ast.visitor.DummyClassToDetermineVariableType;//####[3]####
import pt.runtime.*;//####[4]####
import pj.Pyjama;//####[5]####
import pj.PJPackageOnly;//####[6]####
import pj.UniqueThreadIdGeneratorForOpenMP;//####[7]####
import pi.ParIteratorFactory;//####[8]####
import pi.ParIterator;//####[9]####
import pi.reductions.Reducible;//####[10]####
import pi.reductions.Reduction;//####[11]####
import java.util.concurrent.atomic.*;//####[12]####
import java.util.concurrent.*;//####[13]####
import java.awt.EventQueue;//####[14]####
import java.util.concurrent.ExecutorService;//####[15]####
import java.util.concurrent.Executors;//####[16]####
import java.util.concurrent.TimeUnit;//####[17]####
import javax.swing.SwingUtilities;//####[18]####
import pj.parser.ast.visitor.DummyClassToDetermineVariableType;//####[19]####
import pj.*;//####[20]####
import java.io.File;//####[21]####
import java.io.IOException;//####[22]####
import java.util.concurrent.atomic.AtomicInteger;//####[23]####
import java.util.Arrays;//####[24]####
import javax.xml.XMLConstants;//####[25]####
import javax.xml.parsers.ParserConfigurationException;//####[26]####
import javax.xml.transform.Source;//####[27]####
import javax.xml.transform.stream.StreamSource;//####[28]####
import javax.xml.validation.Schema;//####[29]####
import javax.xml.validation.SchemaFactory;//####[30]####
import javax.xml.validation.Validator;//####[31]####
import org.xml.sax.SAXException;//####[32]####
import spec.harness.Constants;//####[33]####
import spec.harness.Context;//####[34]####
import spec.harness.Launch;//####[35]####
import spec.harness.Util;//####[36]####
import spec.harness.results.BenchmarkResult;//####[37]####
import spec.io.FileCache;//####[38]####
import spec.io.FileCache.CachedFile;//####[39]####
import spec.benchmarks.xml.XMLBenchmark;//####[40]####
import pi.reductions.Reducible;//####[42]####
import java.util.*;//####[43]####
//####[43]####
//-- ParaTask related imports//####[43]####
import pt.runtime.*;//####[43]####
import java.util.concurrent.ExecutionException;//####[43]####
import java.util.concurrent.locks.*;//####[43]####
import java.lang.reflect.*;//####[43]####
import pt.runtime.GuiThread;//####[43]####
import java.util.concurrent.BlockingQueue;//####[43]####
import java.util.ArrayList;//####[43]####
import java.util.List;//####[43]####
//####[43]####
public class Main extends XMLBenchmark {//####[45]####
    static{ParaTask.init();}//####[45]####
    /*  ParaTask helper method to access private/protected slots *///####[45]####
    public void __pt__accessPrivateSlot(Method m, Object instance, TaskID arg, Object interResult ) throws IllegalArgumentException, IllegalAccessException, InvocationTargetException {//####[45]####
        if (m.getParameterTypes().length == 0)//####[45]####
            m.invoke(instance);//####[45]####
        else if ((m.getParameterTypes().length == 1))//####[45]####
            m.invoke(instance, arg);//####[45]####
        else //####[45]####
            m.invoke(instance, arg, interResult);//####[45]####
    }//####[45]####
//####[46]####
    private static final int XSD_NUMBER = 6;//####[46]####
//####[46]####
    private static FileCache.CachedFile[] allInstanceBytes;//####[46]####
//####[46]####
    private static FileCache.CachedFile[] allSchemaBytes;//####[46]####
//####[46]####
    private static Validator[][] allValidators;//####[46]####
//####[46]####
    private static int THREADSNUM = 4;//####[46]####
//####[46]####
    public static String testType() {//####[46]####
        {//####[46]####
            return MULTI;//####[47]####
        }//####[48]####
    }//####[49]####
//####[50]####
    private static ArrayList<ParIterator<?>> _omp_piVarContainer = new ArrayList<ParIterator<?>>();//####[50]####
//####[51]####
    private static AtomicBoolean _holderForPIFirst = new AtomicBoolean(false);//####[51]####
//####[53]####
    private static String[] schemaNames = { "validation_input.xsd", "periodic_table.xsd", "play.xsd", "structure.xsd", "po.xsd", "personal.xsd" };//####[53]####
//####[53]####
    private static String[] instanceNames = { "validation_input.xml", "periodicxsd.xml", "much_adoxsd.xml", "structure.xml", "po.xml", "personal.xml" };//####[53]####
//####[53]####
    private static int loops[] = { 1, 5, 3, 52, 647, 419 };//####[53]####
//####[53]####
    public static void setupBenchmark() {//####[53]####
        {//####[53]####
            String dirName = Util.getProperty(Constants.XML_VALIDATION_INPUT_DIR_PROP, null);//####[54]####
            try {//####[55]####
                allInstanceBytes = new FileCache.CachedFile[XSD_NUMBER];//####[56]####
                FileCache cache = Context.getFileCache();//####[57]####
                for (int i = 0; i < XSD_NUMBER; i++) //####[58]####
                {//####[59]####
                    String name = getFullName(Main.class, dirName, instanceNames[i]);//####[60]####
                    allInstanceBytes[i] = cache.new CachedFile(name);//####[61]####
                    allInstanceBytes[i].cache();//####[62]####
                }//####[63]####
                allSchemaBytes = new FileCache.CachedFile[XSD_NUMBER];//####[64]####
                for (int i = 0; i < XSD_NUMBER; i++) //####[65]####
                {//####[66]####
                    String name = getFullName(Main.class, dirName, schemaNames[i]);//####[67]####
                    allSchemaBytes[i] = cache.new CachedFile(name);//####[68]####
                    allSchemaBytes[i].cache();//####[69]####
                }//####[70]####
                setupValidators(dirName);//####[71]####
            } catch (IOException e) {//####[72]####
                e.printStackTrace(Context.getOut());//####[73]####
            }//####[74]####
        }//####[75]####
    }//####[76]####
//####[78]####
    private static void setupValidators(String dirName) {//####[78]####
        {//####[78]####
            int threads = Launch.currentNumberBmThreads;//####[79]####
            allValidators = new Validator[threads][XSD_NUMBER];//####[80]####
            try {//####[81]####
                SchemaFactory sf = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);//####[82]####
                sf.setErrorHandler(null);//####[83]####
                for (int i = 0; i < XSD_NUMBER; i++) //####[84]####
                {//####[85]####
                    String xsdFilename = getFullName(Main.class, dirName, schemaNames[i]);//####[86]####
                    File tempURI = new File(xsdFilename);//####[87]####
                    Schema precompSchema;//####[88]####
                    if (tempURI.isAbsolute()) //####[89]####
                    {//####[90]####
                        precompSchema = sf.newSchema(new StreamSource(allSchemaBytes[i].getStream(), tempURI.toURI().toString()));//####[91]####
                    } else {//####[92]####
                        precompSchema = sf.newSchema(new StreamSource(allSchemaBytes[i].getStream(), xsdFilename));//####[93]####
                    }//####[94]####
                    for (int j = 0; j < threads; j++) //####[95]####
                    {//####[96]####
                        allValidators[j][i] = precompSchema.newValidator();//####[97]####
                    }//####[98]####
                }//####[99]####
            } catch (SAXException e) {//####[100]####
                e.printStackTrace();//####[101]####
            } catch (Exception e) {//####[102]####
                e.printStackTrace();//####[103]####
            }//####[104]####
        }//####[105]####
    }//####[106]####
//####[108]####
    private Validator[] schemaBoundValidator;//####[108]####
//####[108]####
    public Main(BenchmarkResult bmResult, int threadId) {//####[108]####
        super(bmResult, threadId);//####[109]####
        schemaBoundValidator = allValidators[threadId - 1];//####[110]####
    }//####[111]####
//####[111]####
    public void harnessMain() {//####[111]####
        {//####[111]####
            try {//####[112]####
                long start = System.currentTimeMillis();//####[113]####
                executeWorkload();//####[114]####
                long time = System.currentTimeMillis() - start;//####[115]####
                System.out.println("PJ Parallel xml validation has taken  " + (time / 1000.0) + " seconds.");//####[116]####
            } catch (Exception e) {//####[117]####
                e.printStackTrace(Context.getOut());//####[118]####
            }//####[119]####
        }//####[120]####
    }//####[121]####
//####[123]####
    public static void main(String[] args) throws Exception {//####[123]####
        Pyjama.init();//####[124]####
        {//####[125]####
            runSimple(Main.class, args);//####[126]####
        }//####[127]####
    }//####[128]####
//####[130]####
    private void executeWorkload() throws ParserConfigurationException, IOException, SAXException {//####[130]####
        {//####[130]####
            Pyjama.omp_set_num_threads(THREADSNUM);//####[131]####
            if (Pyjama.insideParallelRegion()) //####[133]####
            {//####[133]####
                {//####[135]####
                    for (int i = 0; i < XSD_NUMBER; i = i + 1) //####[136]####
                    {//####[137]####
                        Context.getOut().println("Validating " + instanceNames[i]);//####[138]####
                        try {//####[139]####
                            doValidationTests(loops[i], allInstanceBytes[i], schemaBoundValidator[i]);//####[140]####
                        } catch (SAXException e) {//####[141]####
                            e.printStackTrace();//####[142]####
                        } catch (Exception e) {//####[143]####
                            e.printStackTrace();//####[144]####
                        }//####[145]####
                    }//####[146]####
                }//####[147]####
            } else {//####[148]####
                PJPackageOnly.setThreadCountCurrentParallelRegion(Pyjama.omp_get_num_threads());//####[150]####
                _omp__parallelRegionVarHolderClass_Main0 _omp__parallelRegionVarHolderInstance_0 = new _omp__parallelRegionVarHolderClass_Main0();//####[153]####
                PJPackageOnly.setMasterThread(Thread.currentThread());//####[156]####
                TaskID _omp__parallelRegionTaskID_0 = _ompParallelRegion_0(_omp__parallelRegionVarHolderInstance_0);//####[157]####
                __pt___ompParallelRegion_0(_omp__parallelRegionVarHolderInstance_0);//####[158]####
                try {//####[159]####
                    _omp__parallelRegionTaskID_0.waitTillFinished();//####[159]####
                } catch (Exception __pt__ex) {//####[159]####
                    __pt__ex.printStackTrace();//####[159]####
                }//####[159]####
                PJPackageOnly.setMasterThread(null);//####[161]####
                _holderForPIFirst.set(true);//####[162]####
                PJPackageOnly.setThreadCountCurrentParallelRegion(1);//####[164]####
            }//####[165]####
        }//####[168]####
    }//####[169]####
//####[170]####
    private AtomicBoolean _imFirst_2 = new AtomicBoolean(true);//####[170]####
//####[171]####
    private AtomicInteger _imFinishedCounter_2 = new AtomicInteger(0);//####[171]####
//####[172]####
    private CountDownLatch _waitBarrier_2 = new CountDownLatch(1);//####[172]####
//####[173]####
    private CountDownLatch _waitBarrierAfter_2 = new CountDownLatch(1);//####[173]####
//####[174]####
    private ParIterator<Integer> _pi_2 = null;//####[174]####
//####[175]####
    private Integer _lastElement_2 = null;//####[175]####
//####[176]####
    private _ompWorkSharedUserCode_Main2_variables _ompWorkSharedUserCode_Main2_variables_instance = null;//####[176]####
//####[177]####
    private void _ompWorkSharedUserCode_Main2(_ompWorkSharedUserCode_Main2_variables __omp_vars) {//####[177]####
        Integer i;//####[179]####
        while (_pi_2.hasNext()) //####[180]####
        {//####[180]####
            i = _pi_2.next();//####[181]####
            {//####[183]####
                Context.getOut().println("Validating " + instanceNames[i]);//####[184]####
                try {//####[185]####
                    doValidationTests(loops[i], allInstanceBytes[i], schemaBoundValidator[i]);//####[186]####
                } catch (SAXException e) {//####[187]####
                    e.printStackTrace();//####[188]####
                } catch (Exception e) {//####[189]####
                    e.printStackTrace();//####[190]####
                }//####[191]####
            }//####[192]####
        }//####[193]####
    }//####[195]####
//####[199]####
    private static volatile Method __pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method = null;//####[199]####
    private synchronized static void __pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_ensureMethodVarSet() {//####[199]####
        if (__pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method == null) {//####[199]####
            try {//####[199]####
                __pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method = ParaTaskHelper.getDeclaredMethod(new ParaTaskHelper.ClassGetter().getCurrentClass(), "__pt___ompParallelRegion_0", new Class[] {//####[199]####
                    _omp__parallelRegionVarHolderClass_Main0.class//####[199]####
                });//####[199]####
            } catch (Exception e) {//####[199]####
                e.printStackTrace();//####[199]####
            }//####[199]####
        }//####[199]####
    }//####[199]####
    private TaskIDGroup<Void> _ompParallelRegion_0(_omp__parallelRegionVarHolderClass_Main0 __omp_vars) {//####[199]####
        //-- execute asynchronously by enqueuing onto the taskpool//####[199]####
        return _ompParallelRegion_0(__omp_vars, new TaskInfo());//####[199]####
    }//####[199]####
    private TaskIDGroup<Void> _ompParallelRegion_0(_omp__parallelRegionVarHolderClass_Main0 __omp_vars, TaskInfo taskinfo) {//####[199]####
        // ensure Method variable is set//####[199]####
        if (__pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method == null) {//####[199]####
            __pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_ensureMethodVarSet();//####[199]####
        }//####[199]####
        taskinfo.setParameters(__omp_vars);//####[199]####
        taskinfo.setMethod(__pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method);//####[199]####
        taskinfo.setInstance(this);//####[199]####
        return TaskpoolFactory.getTaskpool().enqueueMulti(taskinfo, Pyjama.omp_get_num_threads() - 1);//####[199]####
    }//####[199]####
    private TaskIDGroup<Void> _ompParallelRegion_0(TaskID<_omp__parallelRegionVarHolderClass_Main0> __omp_vars) {//####[199]####
        //-- execute asynchronously by enqueuing onto the taskpool//####[199]####
        return _ompParallelRegion_0(__omp_vars, new TaskInfo());//####[199]####
    }//####[199]####
    private TaskIDGroup<Void> _ompParallelRegion_0(TaskID<_omp__parallelRegionVarHolderClass_Main0> __omp_vars, TaskInfo taskinfo) {//####[199]####
        // ensure Method variable is set//####[199]####
        if (__pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method == null) {//####[199]####
            __pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_ensureMethodVarSet();//####[199]####
        }//####[199]####
        taskinfo.setTaskIdArgIndexes(0);//####[199]####
        taskinfo.addDependsOn(__omp_vars);//####[199]####
        taskinfo.setParameters(__omp_vars);//####[199]####
        taskinfo.setMethod(__pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method);//####[199]####
        taskinfo.setInstance(this);//####[199]####
        return TaskpoolFactory.getTaskpool().enqueueMulti(taskinfo, Pyjama.omp_get_num_threads() - 1);//####[199]####
    }//####[199]####
    private TaskIDGroup<Void> _ompParallelRegion_0(BlockingQueue<_omp__parallelRegionVarHolderClass_Main0> __omp_vars) {//####[199]####
        //-- execute asynchronously by enqueuing onto the taskpool//####[199]####
        return _ompParallelRegion_0(__omp_vars, new TaskInfo());//####[199]####
    }//####[199]####
    private TaskIDGroup<Void> _ompParallelRegion_0(BlockingQueue<_omp__parallelRegionVarHolderClass_Main0> __omp_vars, TaskInfo taskinfo) {//####[199]####
        // ensure Method variable is set//####[199]####
        if (__pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method == null) {//####[199]####
            __pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_ensureMethodVarSet();//####[199]####
        }//####[199]####
        taskinfo.setQueueArgIndexes(0);//####[199]####
        taskinfo.setIsPipeline(true);//####[199]####
        taskinfo.setParameters(__omp_vars);//####[199]####
        taskinfo.setMethod(__pt___ompParallelRegion_0__omp__parallelRegionVarHolderClass_Main0_method);//####[199]####
        taskinfo.setInstance(this);//####[199]####
        return TaskpoolFactory.getTaskpool().enqueueMulti(taskinfo, Pyjama.omp_get_num_threads() - 1);//####[199]####
    }//####[199]####
    public void __pt___ompParallelRegion_0(_omp__parallelRegionVarHolderClass_Main0 __omp_vars) {//####[199]####
        {//####[201]####
            if (Pyjama.insideParallelRegion()) //####[202]####
            {//####[202]####
                boolean _omp_imFirst = _imFirst_2.getAndSet(false);//####[204]####
                _holderForPIFirst = _imFirst_2;//####[205]####
                if (_omp_imFirst) //####[206]####
                {//####[206]####
                    _ompWorkSharedUserCode_Main2_variables_instance = new _ompWorkSharedUserCode_Main2_variables();//####[207]####
                    int __omp_size_ = 0;//####[208]####
                    for (int i = 0; i < XSD_NUMBER; i = i + 1) //####[210]####
                    {//####[210]####
                        _lastElement_2 = i;//####[211]####
                        __omp_size_++;//####[212]####
                    }//####[213]####
                    _pi_2 = ParIteratorFactory.createParIterator(0, __omp_size_, 1, Pyjama.omp_get_num_threads(), ParIterator.Schedule.GUIDED, ParIterator.DEFAULT_CHUNKSIZE, false);//####[214]####
                    _omp_piVarContainer.add(_pi_2);//####[215]####
                    _pi_2.setThreadIdGenerator(new UniqueThreadIdGeneratorForOpenMP());//####[216]####
                    _waitBarrier_2.countDown();//####[217]####
                } else {//####[218]####
                    try {//####[219]####
                        _waitBarrier_2.await();//####[219]####
                    } catch (InterruptedException __omp__ie) {//####[219]####
                        __omp__ie.printStackTrace();//####[219]####
                    }//####[219]####
                }//####[220]####
                _ompWorkSharedUserCode_Main2(_ompWorkSharedUserCode_Main2_variables_instance);//####[221]####
                if (_imFinishedCounter_2.incrementAndGet() == PJPackageOnly.getThreadCountCurrentParallelRegion()) //####[222]####
                {//####[222]####
                    _waitBarrierAfter_2.countDown();//####[223]####
                } else {//####[224]####
                    try {//####[225]####
                        _waitBarrierAfter_2.await();//####[226]####
                    } catch (InterruptedException __omp__ie) {//####[227]####
                        __omp__ie.printStackTrace();//####[228]####
                    }//####[229]####
                }//####[230]####
            } else {//####[232]####
                for (int i = 0; i < XSD_NUMBER; i = i + 1) //####[234]####
                {//####[235]####
                    Context.getOut().println("Validating " + instanceNames[i]);//####[236]####
                    try {//####[237]####
                        doValidationTests(loops[i], allInstanceBytes[i], schemaBoundValidator[i]);//####[238]####
                    } catch (SAXException e) {//####[239]####
                        e.printStackTrace();//####[240]####
                    } catch (Exception e) {//####[241]####
                        e.printStackTrace();//####[242]####
                    }//####[243]####
                }//####[244]####
            }//####[245]####
        }//####[247]####
    }//####[249]####
//####[249]####
//####[250]####
    private void doValidationTests(int loops, CachedFile file, Validator schemaValidator) throws ParserConfigurationException, IOException, SAXException {//####[250]####
        {//####[250]####
            for (int i = loops - 1; i >= 0; i--) //####[251]####
            {//####[252]####
                validateSource(i, createDomSource(file), schemaValidator);//####[253]####
                validateSource(i, createSaxSource(file), schemaValidator);//####[254]####
            }//####[255]####
        }//####[256]####
    }//####[257]####
//####[259]####
    private void validateSource(int loop, Source source, Validator schemaValidator) {//####[259]####
        {//####[259]####
            schemaValidator.reset();//####[260]####
            schemaValidator.setErrorHandler(null);//####[261]####
            try {//####[262]####
                schemaValidator.validate(source);//####[263]####
            } catch (SAXException e) {//####[264]####
                Context.getOut().print("\tas " + source.getClass().getName());//####[265]####
                Context.getOut().println(" failed. (Incorrect result)" + Arrays.toString(loops));//####[266]####
                e.printStackTrace(Context.getOut());//####[267]####
            } catch (IOException e) {//####[268]####
                Context.getOut().println("Unable to validate due to IOException.");//####[269]####
            }//####[270]####
        }//####[271]####
    }//####[272]####
}//####[272]####
